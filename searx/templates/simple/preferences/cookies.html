<p class="text-muted">
  {{- _('This is the list of cookies and their values SearXNG is storing on your computer.') }}
  <br>{{- _('With this list, you can assess the transparency of SearXNG.') -}}
  <br>{{- '' -}}
</p>
{% if cookies %}
  <table class="cookies">
    <tr>{{- '' -}}
      <th>{{ _('Cookie name') }}</th>{{- '' -}}
      <th>{{ _('Value') }}</th>{{- '' -}}
    </tr>
    {%- for cookie in cookies -%}
      <tr>{{- '' -}}
        <td>{{ cookie }}</td>{{- '' -}}
        <td>{{ cookies[cookie] }}</td>{{- '' -}}
      </tr>
    {%- endfor -%}
  </table>
{%- else -%}
  {% include 'simple/messages/no_cookies.html' %}
{% endif %}
<h4>
  {{- _('Search URL of the currently saved preferences') -}}:{{- '' -}}
</h4>{{- '' -}}
<div class="selectable_url">{{- '' -}}
  <pre>
    {{- url_for('index', _external=True) -}}?preferences={{- preferences_url_params|e -}}
    {%- raw -%}&amp;q=%s{%- endraw -%}
  </pre>{{- '' -}}
</div>{{- '' -}}
<p class="small_font">
  {{- _('Note: specifying custom settings in the search URL can reduce privacy by leaking data to the clicked result sites.') -}}
</p>
<h4>
  {{- _('URL to restore your preferences in another browser') -}}:{{- '' -}}
</h4>{{- '' -}}
<div class="selectable_url">{{- '' -}}
  <pre>
    {{- url_for('preferences', _external=True) -}}?preferences={{- preferences_url_params|e -}}{{- '' -}}
  </pre>{{- '' -}}
</div>{{- '' -}}
<p class="small_font">
  {{- _('A URL containing your preferences. This URL can be used to restore your settings on a different device.') -}}
</p>
<h4>
  {{- _('Copy preferences hash') -}}:{{- '' -}}
</h4>{{- '' -}}
<div id="copy-hash-container">{{- '' -}}
  <div class="selectable_url">{{- '' -}}
    <pre>
      {{- preferences_url_params|e }}
    </pre>{{- '' -}}
  </div>
  <button id="copy-hash" type="button" class="button" data-hash="{{- preferences_url_params|e -}}" data-copied-text="{{- _('Copied') -}}">{{- _('Copy') -}}</button>
</div>
<h4>
  {{- _('Insert copied preferences hash (without URL) to restore') -}}:{{- '' -}}
</h4>{{- '' -}}
<input type="text" id="pref-hash-input" name="preferences" placeholder="{{- _('Preferences hash') -}}">{{- '' -}}


<hr>
<h3 id="profiles">Profiles</h3>
<p class="small_font">Save named profiles that redirect to absolute URLs with your SearXNG preferences. Use the instant-apply link below or paste any https URL.</p>
<div id="profile-add" class="profile-add">
  <label for="profile-name" style="display:block; margin-top:0.5rem;">Profile name</label>
  <input type="text" id="profile-name" placeholder="My Profile" style="width:100%; max-width:28rem;">
  <label for="profile-url" style="display:block; margin-top:0.5rem;">Profile URL</label>
  <input type="url" id="profile-url" class="profile-url" style="width:100%; max-width:48rem;" value="{{ url_for('preferences', _external=True) }}?preferences={{ preferences_url_params|e }}">
  <button id="profile-save" type="button" class="button" style="margin-top:0.5rem;">Save profile</button>
</div>
<div id="profile-list-container" style="margin-top:1rem;">
  <h4>Saved profiles</h4>
  <ul id="profile-list" style="list-style:none; padding-left:0;"></ul>
</div>
<hr>
<div>
  <button id="profile-export" type="button" class="button">Export</button>
  <button id="profile-import" type="button" class="button">Import</button>
  <input type="file" id="profile-import-file" accept="application/json" style="display:none">
</div>
<script>
(function(){
  const key = 'searxng_profiles';
  const listEl = document.getElementById('profile-list');
  const containerEl = document.getElementById('profile-list-container');
  const nameEl = document.getElementById('profile-name');
  const urlEl = document.getElementById('profile-url');
  const saveBtn = document.getElementById('profile-save');
  const exportBtn = document.getElementById('profile-export');
  const importBtn = document.getElementById('profile-import');
  const importFileEl = document.getElementById('profile-import-file');

  function load() {
    try { return JSON.parse(localStorage.getItem(key) || '[]'); }
    catch(e){ return []; }
  }
  function save(profiles){ localStorage.setItem(key, JSON.stringify(profiles)); }
  function render(){
    const profiles = load();
    listEl.innerHTML = '';
    if (!profiles.length) {
      containerEl.style.display = 'none';
      exportBtn.style.display = 'none';
      return;
    }
    exportBtn.style.display = '';
    containerEl.style.display = '';
    profiles.forEach((p, idx)=>{
      if (!p || typeof p.name !== 'string' || typeof p.url !== 'string') return;
      const li = document.createElement('li');
      li.style.margin = '0.25rem 0';
      const a = document.createElement('a');
      a.href = p.url; a.textContent = p.name; a.rel = 'nofollow noopener';
      a.addEventListener('click', (ev)=>{
        if (!/^https?:\/\//i.test(p.url)) { ev.preventDefault(); alert('Invalid profile URL.'); }
      });
      const del = document.createElement('button');
      del.textContent = 'Delete';
      del.className = 'button';
      del.style.marginLeft = '0.5rem';
      del.addEventListener('click', ()=>{
        const arr = load();
        arr.splice(idx, 1);
        save(arr); render();
      });
      li.appendChild(a); li.appendChild(del);
      listEl.appendChild(li);
    });
  }
  function onSave(){
    const name = (nameEl.value || '').trim();
    const url = (urlEl.value || '').trim();
    if (!name) { alert('Please enter a profile name.'); return; }
    if (!/^https?:\/\//i.test(url)) { alert('Please enter a valid absolute http(s) URL.'); return; }
    const profiles = load();
    const existingIdx = profiles.findIndex(p => p && p.name === name);
    const entry = { name, url };
    if (existingIdx >= 0) profiles[existingIdx] = entry; else profiles.push(entry);
    save(profiles); render();
    urlEl.value = '{{ url_for("preferences", _external=True) }}?preferences={{ preferences_url_params|e }}';
  }
  function onExport(){
    const profiles = load();
    if (!profiles.length) { alert('No profiles to export.'); return; }
    const json = JSON.stringify(profiles, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'searxng_profiles.json';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  function onImport(){
    importFileEl.click();
  }
  function onImportFile(ev){
    const file = ev.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      try {
        const imported = JSON.parse(e.target.result);
        if (!Array.isArray(imported)) { throw new Error('Invalid format: not an array.'); }
        const profiles = load();
        let added = 0;
        let replaced = 0;
        for(const p of imported) {
          if (!p || typeof p.name !== 'string' || !p.name.trim() || typeof p.url !== 'string' || !p.url.trim()) continue;
          const existingIdx = profiles.findIndex(x => x && x.name === p.name);
          if (existingIdx >= 0) {
            profiles[existingIdx] = p;
            replaced++;
          } else {
            profiles.push(p);
            added++;
          }
        }
        save(profiles);
        render();
        alert(`Imported ${added} and replaced ${replaced} profiles.`);
      } catch(err) {
        alert('Error importing profiles: ' + err.message);
      } finally {
        importFileEl.value = '';
      }
    };
    reader.readAsText(file);
  }
  render();
  saveBtn.addEventListener('click', onSave);
  exportBtn.addEventListener('click', onExport);
  importBtn.addEventListener('click', onImport);
  importFileEl.addEventListener('change', onImportFile);
})();
</script>
